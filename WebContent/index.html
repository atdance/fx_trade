<!doctype>
<head>
	<title>FX Trade</title>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />

	<link type="text/css" rel="stylesheet" href="http://code.shutterstock.com/rickshaw/src/css/graph.css">
	<link type="text/css" rel="stylesheet" href="http://code.shutterstock.com/rickshaw//src/css/detail.css">
	<link type="text/css" rel="stylesheet" href="http://code.shutterstock.com/rickshaw//src/css/legend.css">
	<link type="text/css" rel="stylesheet" href="http://code.shutterstock.com/rickshaw/examples/css/extensions.css">

	<script src="http://code.shutterstock.com/rickshaw/vendor/d3.v3.js"></script>
	<script src="http://code.shutterstock.com/rickshaw/rickshaw.js"></script>
<script type="text/javascript" 
   src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	
</head>

<body>

<div id="chart_container">

	<div id="chart"></div>
	<div id="legend_container">
		<div id="smoother" title="Smoothing"></div>
		<div id="legend"></div>
	</div>
	
	<div id="slider"></div>
</div>

<script>
function print_r(printthis, returnoutput) {
    var output = '';

    if($.isArray(printthis) || typeof(printthis) == 'object') {
        for(var i in printthis) {
            output += i + ' : ' + print_r(printthis[i], true) + '\n';
        }
    }else {
        output += printthis;
    }
    if(returnoutput && returnoutput == true) {
        return output;
    }else {
        alert(output);
    }
}

var remote = "http://2.65.155.63:8080/restapi/rest/trade/volume";
var test =  "http://web.ict.kth.se/~michelec/fixed.php";
var local = "http://localhost:8080/restapi/rest/trade/volume";
var myURL = local;	
var tv = 2200;
var globaldata;

var ws = null;
var wsURL = 'ws://' + window.location.host + "/restapi/websocket/WsAnnotation";
   
function connect() {
    if (wsURL == '') {
        alert('Please select server side connection implementation.');
        return;
    }
    if ('WebSocket' in window) {
        ws = new WebSocket(wsURL);
    } else if ('MozWebSocket' in window) {
        ws = new MozWebSocket(wsURL);
    } else {
        alert('WebSocket is not supported by this browser.');
        return;
    }
    ws.onopen = function () {
        log('Info: WebSocket connection opened.');
    };
    ws.onmessage = function (event) {
        log('Received: ' + event.data);   
        globaldata = JSON.parse(event.data);
    };
    ws.onclose = function (event) {
    	globaldata = null;
    	log('Info: WebSocket connection closed, Code: ' + event.code + ' Remote service may be down. You may reload this page later.' + (event.reason == "" ? "" : ", Reason: " + event.reason));
    };
}

function disconnect() {
    if (ws != null) {
        ws.close();
        ws = null;
    }
}
//not used
function pollServer() {
    if (ws != null) {
        var message = "";
        //log('Sent: ' + message);
        ws.send(message);
    } else {
        alert('WebSocket connection not established, please connect.You may need to reload this page.');
    }
}

  
function log(message) {
    var console = document.getElementById('response_list');
    var p = document.createElement('p');
    p.style.wordWrap = 'break-word';
    p.appendChild(document.createTextNode(message));
    console.appendChild(p);
    while (console.childNodes.length > 1) {
        console.removeChild(console.firstChild);
    }
    console.scrollTop = console.scrollHeight;
}

connect();


// instantiate our graph!
var graph = new Rickshaw.Graph( {
	element: document.getElementById("chart"),
	width: 900,
	height: 500,
	renderer: 'line',
	series: new Rickshaw.Series.FixedDuration(
			[{ name: 'eur' },{ name: 'gbp' }],
			undefined, {
		timeInterval: tv,
		maxDataPoints: 100,
		timeBase: new Date().getTime() / 1000
	}) 
} );

var hoverDetail = new Rickshaw.Graph.HoverDetail( {
	graph: graph
} );

var legend = new Rickshaw.Graph.Legend( {
	graph: graph,
	element: document.getElementById('legend')

} );

var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
	graph: graph,
	legend: legend
} );

var x_axis = new Rickshaw.Graph.Axis.Time( { graph: graph } );

var y_axis = new Rickshaw.Graph.Axis.Y( {
        graph: graph,
        orientation: 'right',
        tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
        element: document.getElementById('y_axis'),
} );

graph.render();


// update at intervals
var iv = setInterval( function() {
	//pollServer();
	graph.series.addData(globaldata);
	graph.render();
}, tv );

//not used
var	getLatestData = function() {	
	   $.ajax({
     	dataType: "json",
      url: myURL,
      success: function(data) {
         globaldata = data;
      }
    });	
};

//not used
var getRandomData =  function(){
	var data = { eur: Math.floor(Math.random() * 40) + 120 };
	var randInt = Math.floor(Math.random()*100);
	data.gbp = (Math.sin(i++ / 40) + 4) * (randInt + 400);
	globaldata = data;
	return data;		
};
</script>

    <div id="console-container">
        <div id="response_list">
        </div>
    </div>

</body>
</html>